
<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>D20 Pocket Companion</title>
	<link rel="icon" href="https://raw.githubusercontent.com/Kiderobin/D20/main/pics/d20.png" type="image/png">
	<link href="https://fonts.googleapis.com/css2?family=Permanent+Marker&display=swap" rel="stylesheet">
	<style>
		body {
			font-family: 'Permanent Marker', cursive;
			background: linear-gradient(to bottom, #3a3a3a, #1e1e1e);
			color: #f0f0f0;
			margin: 0;
			min-height: 100vh;
			display: flex;
			flex-direction: column;
		}
		.main-container {
			flex: 1;
			display: flex;
			flex-direction: column;
			align-items: center;
			justify-content: flex-start;
			width: 100vw;
			max-width: 480px;
			margin: 0 auto;
			padding-bottom: 70px;
		}
		.vertical-section {
			width: 100%;
			max-width: 480px;
			margin: 0 auto;
			padding: 16px 8px 0 8px;
			box-sizing: border-box;
		}
		.menu-bar {
			position: fixed;
			bottom: 0;
			left: 0;
			width: 100vw;
			background: #2c2c2c;
			border-top: 2px solid #676767;
			display: flex;
			justify-content: space-around;
			align-items: center;
			height: 60px;
			z-index: 1000;
		}
		.menu-btn {
			background: none;
			border: none;
			color: #f0f0f0;
			font-size: 1.1em;
			display: flex;
			flex-direction: column;
			align-items: center;
			cursor: pointer;
			flex: 1;
			height: 100%;
			justify-content: center;
		}
		.menu-btn img {
			width: 32px;
			height: 32px;
			margin-bottom: 2px;
		}
		.active {
			color: #ffcc33;
		}
		.hidden { display: none !important; }
		.portrait-img {
			width: 249.6px;
			height: 479.6px;
			border-radius: 10px;
			border: 5px solid #000;
			object-fit: cover;
			margin: 0 auto 16px auto;
			display: block;
		}
		.dice-result {
			text-align: center;
			font-size: 2.5em;
			color: #533663;
			font-weight: bold;
			margin-bottom: 12px;
		}
		.dice-img {
			width: 70vw;
			max-width: 300px;
			height: auto;
			display: block;
			margin: 0 auto 16px auto;
		}
		.input-row, .select-row {
			display: flex;
			gap: 8px;
			margin-bottom: 12px;
			align-items: center;
		}
		.input-row input, .select-row select {
			flex: 1;
			font-size: 1.1em;
			padding: 8px;
			border-radius: 5px;
			border: 1px solid #676767;
			background: #2c2c2c;
			color: #f0f0f0;
		}
		.section-title {
			font-size: 1.3em;
			color: #ffcc33;
			margin-bottom: 12px;
			text-align: center;
		}
		.health-bar-container {
			width: 100%;
			max-width: 320px;
			height: 24px;
			background: #2c2c2c;
			border: 2px solid #676767;
			border-radius: 10px;
			margin: 12px auto 18px auto;
			position: relative;
			overflow: hidden;
		}
		.health-bar {
			position: absolute;
			left: 0; top: 0; bottom: 0;
			height: 100%;
			background: linear-gradient(to right, #33ff66, #66ff99);
			transition: width 0.3s, background 0.4s;
			z-index: 1;
		}
		.health-text {
			position: absolute;
			width: 100%;
			text-align: center;
			color: #f0f0f0;
			font-size: 1em;
			line-height: 24px;
			z-index: 2;
			cursor: pointer;
		}
		.action-slots {
			display: flex;
			flex-wrap: wrap;
			gap: 8px;
			justify-content: center;
			margin-bottom: 12px;
		}
		.action-slot {
			width: 56px;
			height: 56px;
			border: 2px solid #676767;
			border-radius: 50%;
			background: #1e1e1e;
			color: #f0f0f0;
			font-size: 1.1em;
			display: flex;
			align-items: center;
			justify-content: center;
			cursor: pointer;
			position: relative;
			overflow: hidden;
		}
		.action-slot img {
			width: 100%;
			height: 100%;
			object-fit: cover;
		}
		.passive-skill-list {
			display: flex;
			flex-direction: column;
			gap: 10px;
			margin-bottom: 16px;
		}
		.passive-skill-item {
			background: #2c2c2c;
			border: 2px solid #676767;
			border-radius: 8px;
			padding: 10px;
			display: flex;
			align-items: center;
			gap: 12px;
		}
		.passive-skill-item img {
			width: 40px;
			height: 40px;
			border-radius: 5px;
			object-fit: cover;
		}
		.passive-skill-info {
			flex: 1;
		}
		.passive-skill-title {
			font-weight: bold;
			color: #ffcc33;
			margin-bottom: 2px;
		}
		.passive-skill-desc {
			font-size: 0.98em;
			color: #f0f0f0;
		}
		.modal-bg {
			position: fixed;
			top: 0; left: 0; right: 0; bottom: 0;
			background: rgba(0,0,0,0.7);
			z-index: 2000;
			display: flex;
			align-items: center;
			justify-content: center;
		}
		.modal-content {
			background: #2c2c2c;
			border: 2px solid #676767;
			border-radius: 10px;
			padding: 24px 18px;
			color: #f0f0f0;
			max-width: 90vw;
			max-height: 90vh;
			overflow-y: auto;
			box-shadow: 0px 4px 12px rgba(0,0,0,0.6);
		}
		.close-btn {
			position: absolute;
			top: 8px;
			right: 12px;
			font-size: 1.5em;
			color: #ff3333;
			background: none;
			border: none;
			cursor: pointer;
		}
	</style>
	<script src="data.js"></script>
</head>
<body>
	<div class="main-container">
		<!-- Dice Section -->
		<div id="diceSection" class="vertical-section hidden" style="display:flex;flex-direction:column;align-items:center;justify-content:center;height:calc(100vh - 70px);min-height:350px;">
			<div class="section-title">Roll a D20</div>
			<div style="position:relative;display:flex;flex-direction:column;align-items:center;justify-content:center;width:100%;max-width:300px;height:300px;">
				<button id="rollDieBtn" style="background:none;border:none;cursor:pointer;position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1;">
					<img src="https://raw.githubusercontent.com/Kiderobin/D20/main/pics/20SidedDie.png" class="dice-img" alt="Roll D20" style="display:block;margin:0 auto;">
				</button>
				   <div id="diceResult" class="dice-result" style="position:absolute;top: 49%;left: 52%;transform:translate(-50%,-50%);z-index:2;pointer-events:none;font-size:48px;color:#533663;font-weight:bold;font-family:Arial,sans-serif;">-</div>
			</div>
			<audio id="diceSound" src="https://raw.githubusercontent.com/Kiderobin/D20/main/sounds/diceroll.mp3"></audio>
		</div>
		<!-- Character Section -->
		<div id="characterSection" class="vertical-section hidden">
			<div class="section-title">Character Portrait</div>
			<img id="portraitImage" src="placeholder.jpg" class="portrait-img" alt="Character Portrait" onclick="openPortraitPicker()">
			<input type="file" id="portraitInput" accept="image/*" style="display:none;">
		</div>
		<!-- Info Section -->
		<div id="infoSection" class="vertical-section hidden">
			<div class="section-title">Character Info</div>
			<div class="input-row"><input id="characterName" type="text" placeholder="Name"></div>
			<div class="input-row"><input id="level" type="number" min="1" placeholder="Level"></div>
			<div class="input-row"><input id="currency" type="number" min="0" placeholder="Currency"></div>
			<div class="select-row">
				<select id="raceInfoSelect"><option value="">Race</option></select>
				<select id="classInfoSelect"><option value="">Class</option></select>
				<select id="subclassInfoSelect" style="flex:2;"><option value="">Subclass</option></select>
			</div>
			<div class="health-bar-container" onclick="editHealth()">
				<div class="health-bar" id="healthBar"></div>
				<div class="health-text" id="healthText">100/100</div>
			</div>
			<div class="section-title" style="font-size:1.1em;margin:8px 0 4px 0;">Action Slots</div>
			<div class="action-slots" id="actionSlots"></div>
		</div>
		<!-- Passive/Skills Section -->
		<div id="passiveSection" class="vertical-section hidden">
			<div class="section-title">Passives & Skills</div>
			<div class="passive-skill-list" id="passiveSkillList"></div>
		</div>
	</div>
	<div class="menu-bar">
		<button class="menu-btn active" id="menuDice" onclick="showSection('dice')"><img src="https://raw.githubusercontent.com/Kiderobin/D20/main/pics/20SidedDie.png" alt="Dice">Dice</button>
		<button class="menu-btn" id="menuCharacter" onclick="showSection('character')"><img src="https://raw.githubusercontent.com/Kiderobin/D20/main/pics/portraiticon.png" alt="Character">Character</button>
		<button class="menu-btn" id="menuInfo" onclick="showSection('info')"><img src="https://raw.githubusercontent.com/Kiderobin/D20/main/pics/infoicon.png" alt="Info">Info</button>
		<button class="menu-btn" id="menuPassive" onclick="showSection('passive')"><img src="https://raw.githubusercontent.com/Kiderobin/D20/main/pics/skillicon.png" alt="Skills">Skills</button>
	</div>
	<script>
	// --- Data Loading ---
	let D20_DATA = window.D20_CAMPAIGN_DATA || {};
	function populateDropdowns() {
		const races = D20_DATA.races || [];
		const classes = D20_DATA.classes || [];
		// Info section only
		const raceInfoSel = document.getElementById('raceInfoSelect');
		const classInfoSel = document.getElementById('classInfoSelect');
		const subSel = document.getElementById('subclassInfoSelect');
		raceInfoSel.innerHTML = '<option value="">Race</option>';
		classInfoSel.innerHTML = '<option value="">Class</option>';
		races.forEach(r => raceInfoSel.innerHTML += `<option value="${r.name}">${r.name}</option>`);
		classes.forEach(c => classInfoSel.innerHTML += `<option value="${c.name}">${c.name}</option>`);
		classInfoSel.onchange = function() {
			const className = classInfoSel.value;
			const cls = classes.find(c=>c.name===className);
			subSel.innerHTML = '<option value="">Subclass</option>';
			if(cls && Array.isArray(cls.subclasses)) {
				cls.subclasses.forEach(sub=>{
					subSel.innerHTML += `<option value="${sub.name}">${sub.name}</option>`;
				});
			}
			updateActionSlots();
		};
		subSel.onchange = function() {
			updateActionSlots();
		};
	}
		// --- Remove modal logic ---
	// --- Section Navigation ---
	function showSection(section) {
		document.getElementById('diceSection').classList.add('hidden');
		document.getElementById('characterSection').classList.add('hidden');
		document.getElementById('infoSection').classList.add('hidden');
		document.getElementById('passiveSection').classList.add('hidden');
		document.getElementById('menuDice').classList.remove('active');
		document.getElementById('menuCharacter').classList.remove('active');
		document.getElementById('menuInfo').classList.remove('active');
		document.getElementById('menuPassive').classList.remove('active');
		if(section==='dice') {
			document.getElementById('diceSection').classList.remove('hidden');
			document.getElementById('menuDice').classList.add('active');
		} else if(section==='character') {
			document.getElementById('characterSection').classList.remove('hidden');
			document.getElementById('menuCharacter').classList.add('active');
		} else if(section==='info') {
			document.getElementById('infoSection').classList.remove('hidden');
			document.getElementById('menuInfo').classList.add('active');
		} else if(section==='passive') {
			document.getElementById('passiveSection').classList.remove('hidden');
			document.getElementById('menuPassive').classList.add('active');
		}
	}
	// --- Dice Logic ---
	document.getElementById('rollDieBtn').onclick = function() {
		const result = Math.floor(Math.random()*20)+1;
		document.getElementById('diceResult').textContent = result;
		document.getElementById('diceSound').play();
	};
	// --- Portrait Logic ---
	function openPortraitPicker() {
		document.getElementById('portraitInput').click();
	}
	document.getElementById('portraitInput').addEventListener('change', function(e) {
		const file = e.target.files[0];
		if(file) {
			const reader = new FileReader();
			reader.onload = function(ev) {
				document.getElementById('portraitImage').src = ev.target.result;
			};
			reader.readAsDataURL(file);
		}
	});
	// --- Info Section Logic ---
	function updateInfo() {
		// Sync dropdowns
		document.getElementById('raceInfoSelect').value = document.getElementById('raceInfoSelect').value || document.getElementById('raceSelect').value;
		document.getElementById('classInfoSelect').value = document.getElementById('classInfoSelect').value || document.getElementById('classSelect').value;
		// Subclass
		const className = document.getElementById('classInfoSelect').value;
		const level = parseInt(document.getElementById('level').value) || 1;
		const cls = (D20_DATA.classes||[]).find(c=>c.name===className);
		const subSel = document.getElementById('subclassInfoSelect');
		subSel.innerHTML = '<option value="">Subclass</option>';
		if(cls && Array.isArray(cls.subclasses) && typeof cls.subclasslevel==='number' && level>=cls.subclasslevel) {
			cls.subclasses.forEach(sub=>{
				subSel.innerHTML += `<option value="${sub.name}">${sub.name}</option>`;
			});
		}
		// Health
		updateHealthBar();
		// Update passives/skills
		updatePassives();
	}
	document.getElementById('raceInfoSelect').onchange = updateInfo;
	document.getElementById('classInfoSelect').onchange = function() {
		updateActionSlots();
		updateInfo();
	};
	document.getElementById('subclassInfoSelect').onchange = function() {
		updateActionSlots();
		updateInfo();
	};
	document.getElementById('level').oninput = function() {
		updateHealthBar();
		updatePassives();
	};
	// --- Health Bar Logic ---
	let currentHP = 100;
	let maxHP = 100;
	function updateHealthBar() {
		const level = Math.max(1, parseInt(document.getElementById('level').value)||1);
		maxHP = level*20;
		if(currentHP>maxHP) currentHP=maxHP;
		if(currentHP<0) currentHP=0;
		const percent = (currentHP/maxHP)*100;
		const bar = document.getElementById('healthBar');
		bar.style.width = percent+'%';
		if(percent>=70) bar.style.background = 'linear-gradient(to right, #33ff66, #66ff99)';
		else if(percent>=30) bar.style.background = 'linear-gradient(to right, #ffcc33, #ff9933)';
		else bar.style.background = 'linear-gradient(to right, #ff3333, #ff6666)';
		document.getElementById('healthText').textContent = `${currentHP}/${maxHP}`;
	}
	// Make healthText editable on click, update on blur/enter
	const healthText = document.getElementById('healthText');
	healthText.addEventListener('click', function() {
		healthText.contentEditable = 'true';
		healthText.focus();
	});
	healthText.addEventListener('blur', function() {
		healthText.contentEditable = 'false';
		let text = healthText.textContent.trim();
		let value = text.includes('/') ? text.split('/')[0] : text;
		value = parseInt(value);
		if(!isNaN(value)) {
			currentHP = Math.max(0, Math.min(value, maxHP));
			updateHealthBar();
		} else {
			updateHealthBar();
		}
	});
	healthText.addEventListener('keydown', function(e) {
		if(e.key === 'Enter') {
			healthText.blur();
			e.preventDefault();
		}
	});
	document.getElementById('level').addEventListener('input', updateHealthBar);
	window.addEventListener('load', updateHealthBar);
	// --- Action Slots Logic ---
	function updateActionSlots() {
		const container = document.getElementById('actionSlots');
		container.innerHTML = '';
		// Always show three action slots (1, 2, 3)
		for (let i = 1; i <= 3; i++) {
			const btn = document.createElement('div');
			btn.className = 'action-slot';
			btn.textContent = i;
			container.appendChild(btn);
		}
		// Show a fourth slot if subclass passive has AS, else class passive AS
		const className = document.getElementById('classInfoSelect').value;
		const subclassName = document.getElementById('subclassInfoSelect').value;
		const cls = (D20_DATA.classes || []).find(c => c.name === className);
		let asLabel = null;
		if (cls && Array.isArray(cls.subclasses) && subclassName) {
			const sub = cls.subclasses.find(s => s.name === subclassName);
			if (sub && sub.passive && typeof sub.passive.AS === 'string' && sub.passive.AS.trim() !== '') {
				asLabel = sub.passive.AS;
			}
		}
		if (!asLabel && cls && cls.passive && typeof cls.passive.AS === 'string' && cls.passive.AS.trim() !== '') {
			asLabel = cls.passive.AS;
		}
		if (asLabel) {
			const btn = document.createElement('div');
			btn.className = 'action-slot';
			btn.textContent = asLabel;
			container.appendChild(btn);
		}
	}
	// --- Passives/Skills Logic ---
	function updatePassives() {
		const raceName = document.getElementById('raceInfoSelect').value;
		const className = document.getElementById('classInfoSelect').value;
		const subclassName = document.getElementById('subclassInfoSelect').value;
		const race = (D20_DATA.races||[]).find(r=>r.name===raceName)||{};
		const cls = (D20_DATA.classes||[]).find(c=>c.name===className)||{};
		let sub = null;
		if(cls && subclassName && Array.isArray(cls.subclasses)) sub = cls.subclasses.find(s=>s.name===subclassName);
		const list = document.getElementById('passiveSkillList');
		list.innerHTML = '';
		// Race passives/skills
		let racePassives = Array.isArray(race.passives)?race.passives:(race.passive?[race.passive]:[]);
		let raceSkills = Array.isArray(race.skills)?race.skills:(race.skill?[race.skill]:[]);
		racePassives.forEach(trait=>list.appendChild(makePassiveSkillItem(trait)));
		raceSkills.forEach(skill=>list.appendChild(makePassiveSkillItem(skill)));
		// Class passives/skills
		let classPassives = Array.isArray(cls.passives)?cls.passives:(cls.passive?[cls.passive]:[]);
		let classSkills = Array.isArray(cls.skills)?cls.skills:[];
		classPassives.forEach(trait=>list.appendChild(makePassiveSkillItem(trait)));
		classSkills.forEach(skill=>list.appendChild(makePassiveSkillItem(skill)));
		// Subclass passives/skills
		if(sub) {
			let subPassives = Array.isArray(sub.passives)?sub.passives:(sub.passive?[sub.passive]:[]);
			let subSkills = Array.isArray(sub.skills)?sub.skills:[];
			subPassives.forEach(trait=>list.appendChild(makePassiveSkillItem(trait)));
			subSkills.forEach(skill=>list.appendChild(makePassiveSkillItem(skill)));
		}
	}
	function makePassiveSkillItem(obj) {
		const div = document.createElement('div');
		div.className = 'passive-skill-item';
		const img = document.createElement('img');
		img.src = obj.icon?`icons/${obj.icon}`:'';
		img.alt = obj.name||'';
		div.appendChild(img);
		const info = document.createElement('div');
		info.className = 'passive-skill-info';
		const title = document.createElement('div');
		title.className = 'passive-skill-title';
		title.textContent = obj.name||'';
		info.appendChild(title);
		const desc = document.createElement('div');
		desc.className = 'passive-skill-desc';
		desc.textContent = obj.description||'';
		info.appendChild(desc);
		div.appendChild(info);
		return div;
	}
	// --- Sync Info Section Inputs ---
	document.getElementById('characterName').oninput = updateInfo;
	document.getElementById('currency').oninput = updateInfo;
	// --- Initial Load ---
	window.addEventListener('DOMContentLoaded', function() {
		D20_DATA = window.D20_CAMPAIGN_DATA || {};
		populateDropdowns();
		showSection('dice');
		// Show action slots immediately on load
		updateActionSlots();
		// Also update after dropdowns are populated
		document.getElementById('classInfoSelect').dispatchEvent(new Event('change'));
	});
	</script>
</body>
</html>
